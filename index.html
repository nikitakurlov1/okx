<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OKX - Торговая платформа</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --okx-primary: #00ff5a;
            --okx-primary-hover: #00e54d;
            --okx-bg-primary: #0a0a0a;
            --okx-bg-secondary: #0f0f0f;
            --okx-bg-tertiary: #151515;
            --okx-bg-card: #1a1a1a;
            --okx-text-primary: #ffffff;
            --okx-text-secondary: #999999;
            --okx-text-muted: #666666;
            --okx-border: #222222;
            --okx-border-light: #2a2a2a;
            --okx-success: #00ff5a;
            --okx-danger: #ff4976;
            --okx-warning: #ffa500;
            --okx-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            --okx-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --container-width: 1200px;
            --header-height: 64px;
            --nav-height: 72px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(180deg, var(--okx-bg-primary) 0%, #0d0d0d 50%, var(--okx-bg-primary) 100%);
            color: var(--okx-text-primary);
            padding-bottom: var(--nav-height);
            min-height: 100vh;
            max-width: 100vw;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: var(--container-width);
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Верхняя панель */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 1px solid var(--okx-border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        .balance {
            background: linear-gradient(135deg, var(--okx-bg-card) 0%, rgba(0,255,90,0.05) 100%);
            border: 1px solid var(--okx-border);
            border-radius: 16px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .balance::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,90,0.1), transparent);
            transition: left 0.5s ease;
        }

        .balance:hover::before {
            left: 100%;
        }

        .balance:hover {
            border-color: var(--okx-primary);
            background: linear-gradient(135deg, rgba(0, 255, 90, 0.1) 0%, rgba(0, 255, 90, 0.05) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 90, 0.2);
        }

        .okx {
            font-weight: 800;
            color: var(--okx-primary);
            font-size: 28px;
            letter-spacing: 2px;
            text-shadow: 0 0 30px rgba(0, 255, 90, 0.6);
            position: relative;
            display: inline-block;
            background: linear-gradient(45deg, var(--okx-primary), #00e54d, var(--okx-primary));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .okx::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--okx-primary), transparent);
            opacity: 0.5;
        }

        /* Вкладки */
        .tabs {
            display: flex;
            justify-content: center;
            background: rgba(15, 15, 15, 0.95);
            padding: 12px 0;
            position: sticky;
            top: var(--header-height);
            z-index: 99;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--okx-border);
        }

        .tab {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            color: var(--okx-text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-radius: 8px;
            margin: 0 4px;
        }

        .tab:hover {
            color: var(--okx-text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            color: var(--okx-primary);
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--okx-primary), transparent);
            box-shadow: 0 0 12px rgba(0, 255, 90, 0.6);
            border-radius: 2px;
        }

        /* Фильтры */
        .filters {
            display: flex;
            justify-content: flex-start;
            padding: 16px;
            background: var(--okx-bg-secondary);
            gap: 12px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .filters::-webkit-scrollbar {
            display: none;
        }

        .filter {
            background: linear-gradient(135deg, var(--okx-bg-card) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--okx-border);
            border-radius: 28px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--okx-text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .filter::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,90,0.1), transparent);
            transition: left 0.5s ease;
        }

        .filter:hover::before {
            left: 100%;
        }

        .filter:hover {
            background: linear-gradient(135deg, rgba(0, 255, 90, 0.1) 0%, rgba(0, 255, 90, 0.05) 100%);
            border-color: var(--okx-primary);
            color: var(--okx-text-primary);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), 0 0 15px rgba(0,255,90,0.1);
        }

        .filter.active {
            background: linear-gradient(135deg, rgba(0, 255, 90, 0.15) 0%, rgba(0, 255, 90, 0.08) 100%);
            border-color: var(--okx-primary);
            color: var(--okx-primary);
            box-shadow: 0 0 20px rgba(0,255,90,0.2);
        }

        .filter svg {
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }

        /* Список монет */
        .coin-list {
            padding: 8px 16px 16px;
        }

        .coin {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--okx-bg-card) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--okx-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .coin::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,90,0.1), transparent);
            transition: left 0.5s ease;
        }

        .coin:hover::before {
            left: 100%;
        }

        .coin:hover {
            background: linear-gradient(135deg, var(--okx-bg-tertiary) 0%, rgba(0,255,90,0.05) 100%);
            border-color: var(--okx-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 20px rgba(0,255,90,0.1);
        }

        .coin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .coin-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--coin-color, #222) 0%, rgba(255,255,255,0.1) 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            border: 2px solid var(--okx-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .coin:hover .coin-icon {
            transform: scale(1.1) rotate(8deg);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 0 15px rgba(0,255,90,0.3);
        }

        .coin-name {
            font-weight: 600;
            color: var(--okx-text-primary);
            font-size: 16px;
            letter-spacing: 0.3px;
        }

        .coin-symbol {
            font-size: 13px;
            color: var(--okx-text-muted);
            margin-top: 4px;
            font-weight: 500;
        }

        .coin-price {
            text-align: right;
        }

        .price {
            font-weight: 700;
            font-size: 17px;
            color: var(--okx-text-primary);
            letter-spacing: 0.3px;
        }

        .change {
            font-size: 13px;
            font-weight: 600;
            margin-top: 4px;
            padding: 4px 10px;
            border-radius: 8px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .change.positive {
            color: var(--okx-success);
            background: linear-gradient(135deg, rgba(0, 255, 90, 0.15) 0%, rgba(0, 255, 90, 0.05) 100%);
            border: 1px solid rgba(0, 255, 90, 0.2);
        }

        .change.negative {
            color: var(--okx-danger);
            background: linear-gradient(135deg, rgba(255, 73, 118, 0.15) 0%, rgba(255, 73, 118, 0.05) 100%);
            border: 1px solid rgba(255, 73, 118, 0.2);
        }

        /* Нижняя навигация */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 14px 0 18px;
            border-top: 1px solid var(--okx-border);
            z-index: 1000;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.4);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--okx-text-muted);
            font-size: 11px;
            font-weight: 600;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            position: relative;
        }

        .nav-item svg {
            width: 26px;
            height: 26px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item:hover {
            color: var(--okx-primary);
            background: rgba(0, 255, 90, 0.05);
        }

        .nav-item:hover svg {
            transform: translateY(-3px);
        }

        .nav-item.active {
            color: var(--okx-primary);
            background: rgba(0, 255, 90, 0.08);
        }

        .nav-item.active svg {
            stroke: var(--okx-primary);
            filter: drop-shadow(0 0 8px rgba(0, 255, 90, 0.6));
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: var(--okx-primary);
            border-radius: 0 0 3px 3px;
            box-shadow: 0 2px 8px rgba(0, 255, 90, 0.5);
        }

        /* Custom Checkbox Toggle */
        input[type="checkbox"]#sound-enabled::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            left: 2px;
            top: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="checkbox"]#sound-enabled:checked::before {
            left: 22px;
            background: #0a0a0a;
        }

        /* Modal Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, -45%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        /* Payment Method Button Styles */
        .payment-method-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
        }

        .payment-method-btn:hover {
            background: rgba(0,255,90,0.05);
            border-color: rgba(0,255,90,0.3);
            transform: translateX(4px);
        }

        .payment-method-btn.selected {
            background: rgba(0,255,90,0.1);
            border-color: rgba(0,255,90,0.5);
            box-shadow: 0 0 0 3px rgba(0,255,90,0.1);
        }

        .payment-method-icon {
            width: 40px;
            height: 40px;
            background: rgba(0,255,90,0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            :root {
                --container-width: 960px;
            }
        }

        @media (max-width: 991px) {
            :root {
                --container-width: 720px;
            }
        }

        @media (max-width: 768px) {
            :root {
                --container-width: 540px;
                --header-height: 50px;
            }

            body {
                font-size: 14px;
            }

            header {
                padding: 12px 16px;
            }

            .balance {
                padding: 4px 12px;
                font-size: 13px;
            }

            .okx {
                font-size: 20px;
            }

            .tabs {
                top: var(--header-height);
            }

            .tab {
                padding: 8px 16px;
                font-size: 14px;
            }

            .filters {
                padding: 8px;
                justify-content: flex-start;
                padding-left: 16px;
            }

            .filter {
                padding: 6px 12px;
                font-size: 13px;
            }

            .coin {
                padding: 12px;
            }

            .coin-icon {
                width: 36px;
                height: 36px;
            }

            .coin-name {
                font-size: 15px;
            }

            .coin-symbol {
                font-size: 12px;
            }

            .price {
                font-size: 16px;
            }

            .change {
                font-size: 12px;
            }
        }

        @media (max-width: 576px) {
            :root {
                --container-width: 100%;
                --nav-height: 60px;
            }

            .balance {
                font-size: 12px;
                padding: 4px 10px;
            }

            .okx {
                font-size: 18px;
            }

            .filters {
                padding: 8px 4px;
            }

            .filter {
                padding: 6px 10px;
                font-size: 12px;
            }

            .coin {
                padding: 10px 12px;
            }

            .coin-info {
                gap: 10px;
            }

            .coin-icon {
                width: 32px;
                height: 32px;
            }

            .coin-name {
                font-size: 14px;
            }

            .price {
                font-size: 14px;
            }

            .nav-item {
                font-size: 11px;
            }

            .nav-item svg {
                width: 20px;
                height: 20px;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #00ff5a;
                --background-dark: #0d0d0d;
                --background-light: #1a1a1a;
                --text-primary: #fff;
                --text-secondary: #888;
                --border-color: #1f1f1f;
            }
        }

        /* Support for High Contrast Mode */
        @media (forced-colors: active) {

            .coin-icon,
            .filter,
            .nav-item svg {
                forced-color-adjust: none;
            }
        }

        /* Animations and Transitions for Better Performance */
        @media (prefers-reduced-motion: reduce) {

            *,
            ::before,
            ::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* Performance optimizations for trades */
        .trades-container {
            will-change: transform;
            contain: layout style paint;
        }

        .trade-item {
            will-change: auto;
            contain: layout style;
        }

        /* Smooth scrolling for better UX */
        .coin-list, #trades-list {
            scroll-behavior: smooth;
        }

        /* Optimized button states */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Loading states */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Improved notification positioning */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            max-width: 300px;
            word-wrap: break-word;
        }

        /* Trade status indicators */
        .trade-status-active {
            color: #00ff5a;
        }

        .trade-status-processing {
            color: #ffa500;
        }

        .trade-status-completed {
            color: #00ff5a;
        }

        /* Responsive trade items */
        @media (max-width: 768px) {
            .trade-item {
                padding: 12px;
                margin-bottom: 8px;
            }
            
            .trade-item div {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="balance">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
            <span style="color: var(--okx-text-secondary); font-weight: 500;">Баланс:</span>
            <span id="balance" style="color: var(--okx-primary); font-weight: 700;">0.00</span>
            <span style="color: var(--okx-text-muted); font-size: 12px;">USDT</span>
        </div>
        <div class="okx">OKX</div>
    </header>

    <div class="container" id="page-instruments">
        <div class="tabs">
            <div class="tab active" id="tab-instruments">Инструменты</div>
            <div class="tab" id="tab-trades">Сделки</div>
        </div>

        <div class="filters" id="filters">
            <div class="filter">Все</div>
            <div class="filter">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
                Избранное
            </div>
            <div class="filter">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M23 6l-9.5 9.5-5-5L1 18" />
                    <path d="M17 6h6v6" />
                </svg>
                Лидеры роста
            </div>
            <div class="filter">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
            </div>
        </div>
        <div class="coin-list" id="coin-list">
            <!-- Монеты будут добавлены через JavaScript -->
        </div>
    </div>

    <div class="container" id="page-trading" style="display:none;">
        <div style="margin-top:20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <div style="font-weight:600;font-size:18px;" id="trading-coin-name">TONUSDT</div>
                <button id="switch-coin"
                    style="background:#1a1a1a;color:#00ff5a;border-radius:15px;padding:6px 16px;border:1px solid #444;cursor:pointer;font-size:14px;">Сменить
                    монету</button>
            </div>
            <div id="tradingview-chart"
                style="margin:20px 0;height:350px;border-radius:16px;overflow:hidden;background:#111;"></div>
        </div>
        <div style="background:linear-gradient(135deg, #111 0%, rgba(0,255,90,0.02) 100%);border-radius:24px;padding:32px;margin:24px 0;border:1px solid #222;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
            <div style="display:grid;gap:28px;max-width:600px;margin:0 auto;">
                <!-- Сумма ставки -->
                <div>
                    <div style="color:#888;font-size:14px;margin-bottom:12px;font-weight:500;">Сумма ставки</div>
                    <div style="position:relative;width:100%;">
                        <input id="bet-amount" type="number" min="1" value="10" style="background:linear-gradient(135deg, #1a1a1a 0%, rgba(255,255,255,0.02) 100%);color:#fff;border-radius:16px;padding:16px 20px;border:1px solid #333;
                                font-size:18px;width:100%;outline:none;transition:all 0.3s ease;box-shadow:inset 0 2px 4px rgba(0,0,0,0.2);"
                            placeholder="Введите сумму" onmouseover="this.style.borderColor='#444';this.style.boxShadow='inset 0 2px 4px rgba(0,0,0,0.2), 0 0 10px rgba(0,255,90,0.1)'"
                            onmouseout="this.style.borderColor='#333';this.style.boxShadow='inset 0 2px 4px rgba(0,0,0,0.2)'" onfocus="this.style.borderColor='#00ff5a';this.style.boxShadow='inset 0 2px 4px rgba(0,0,0,0.2), 0 0 15px rgba(0,255,90,0.2)'"
                            onblur="this.style.borderColor='#333';this.style.boxShadow='inset 0 2px 4px rgba(0,0,0,0.2)'" />
                        <span
                            style="position:absolute;right:20px;top:50%;transform:translateY(-50%);color:#666;font-size:14px;font-weight:600;">USDT</span>
                    </div>
                </div>

                <!-- Направление (Long/Short) -->
                <div>
                    <div style="color:#888;font-size:14px;margin-bottom:12px;font-weight:500;">Направление</div>
                    <div style="display:flex;gap:16px;width:100%;">
                        <button class="direction-btn" data-dir="long"
                            style="flex:1;background:linear-gradient(135deg, #1a1a1a 0%, rgba(0,255,90,0.05) 100%);color:#00ff5a;border-radius:18px;padding:16px;
                                border:1px solid #333;cursor:pointer;font-size:16px;font-weight:600;
                                transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden;">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 20V4M5 11l7-7 7 7" />
                            </svg>
                            Long
                        </button>
                        <button class="direction-btn" data-dir="short"
                            style="flex:1;background:linear-gradient(135deg, #1a1a1a 0%, rgba(240,90,80,0.05) 100%);color:#f05a50;border-radius:18px;padding:16px;
                                border:1px solid #333;cursor:pointer;font-size:16px;font-weight:600;
                                transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden;">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 4v16M5 13l7 7 7-7" />
                            </svg>
                            Short
                        </button>
                    </div>
                </div>

                <!-- Время -->
                <div>
                    <div style="color:#888;font-size:14px;margin-bottom:8px;">Время экспирации</div>
                    <div style="display:flex;gap:12px;width:100%;">
                        <button class="time-btn" data-time="1" style="flex:1;background:#1a1a1a;color:#fff;border-radius:15px;padding:12px;
                                border:1px solid #333;cursor:pointer;font-size:16px;transition:all 0.3s ease;">1
                            мин</button>
                        <button class="time-btn" data-time="5" style="flex:1;background:#1a1a1a;color:#fff;border-radius:15px;padding:12px;
                                border:1px solid #333;cursor:pointer;font-size:16px;transition:all 0.3s ease;">5
                            мин</button>
                        <button class="time-btn" data-time="10" style="flex:1;background:#1a1a1a;color:#fff;border-radius:15px;padding:12px;
                                border:1px solid #333;cursor:pointer;font-size:16px;transition:all 0.3s ease;">10
                            мин</button>
                    </div>
                </div>

                <!-- Кнопка размещения ставки -->
                <button id="place-bet" style="background:#00ff5a;color:#111;border-radius:15px;padding:16px;border:none;
                        cursor:pointer;font-size:18px;font-weight:600;width:100%;margin-top:12px;
                        transition:all 0.3s ease;text-transform:uppercase;letter-spacing:1px;"
                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 15px rgba(0,255,90,0.3)'"
                    onmouseout="this.style.transform='';this.style.boxShadow=''">
                    Разместить ставку
                </button>
            </div>
        </div>
    </div>

    <div class="container" id="page-trades" style="display:none;">
        <div class="tabs">
            <div class="tab" id="tab-instruments">Инструменты</div>
            <div class="tab active" id="tab-trades">Сделки</div>
        </div>
        <div style="margin-top:20px;">
            <div id="trades-list" class="trades-container"></div>
        </div>
    </div>

    <div class="container" id="page-settings" style="display:none;">
        <div style="margin-top:20px;max-width:600px;margin-left:auto;margin-right:auto;">
            <!-- Профиль пользователя -->
            <div style="background:linear-gradient(135deg, #111 0%, rgba(0,255,90,0.02) 100%);border-radius:24px;padding:32px;margin-bottom:24px;border:1px solid #222;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                <div style="display:flex;align-items:center;gap:20px;margin-bottom:24px;">
                    <div
                        style="width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg, #1a1a1a 0%, rgba(0,255,90,0.1) 100%);display:flex;align-items:center;justify-content:center;border:2px solid #333;box-shadow:0 4px 15px rgba(0,0,0,0.3);">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#00ff5a" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                    </div>
                    <div>
                        <div style="font-size:22px;font-weight:700;color:#fff;margin-bottom:8px;" id="settings-username">Пользователь
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ff5a" stroke-width="2">
                                <path d="M22 2L11 13" />
                                <path d="M22 2L15 22L11 13L2 9L22 2z" />
                            </svg>
                            <input type="text" id="tg-username" placeholder="Введите username Telegram"
                                style="background:linear-gradient(135deg, #1a1a1a 0%, rgba(255,255,255,0.02) 100%);border:1px solid #333;border-radius:12px;color:#00ff5a;font-size:14px;outline:none;padding:8px 12px;transition:all 0.3s ease;" 
                                onfocus="this.style.borderColor='#00ff5a';this.style.boxShadow='0 0 10px rgba(0,255,90,0.2)'"
                                onblur="this.style.borderColor='#333';this.style.boxShadow='none'" />
                        </div>
                    </div>
                </div>

                <!-- Баланс и операции -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <button id="deposit-button"
                        style="background:linear-gradient(135deg, #1a1a1a 0%, rgba(0,255,90,0.05) 100%);color:#00ff5a;border:1px solid #333;border-radius:18px;padding:16px;
                        cursor:pointer;font-size:16px;font-weight:600;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden;"
                        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(0,255,90,0.2)'"
                        onmouseout="this.style.transform='';this.style.boxShadow='none'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 5v14M5 12h14" />
                        </svg>
                        Пополнить
                    </button>
                    <button id="withdraw-button"
                        style="background:linear-gradient(135deg, #1a1a1a 0%, rgba(240,90,80,0.05) 100%);color:#f05a50;border:1px solid #333;border-radius:18px;padding:16px;
                        cursor:pointer;font-size:16px;font-weight:600;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden;"
                        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(240,90,80,0.2)'"
                        onmouseout="this.style.transform='';this.style.boxShadow='none'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7" />
                        </svg>
                        Вывести
                    </button>
                </div>
            </div>

            <!-- История операций -->
            <div style="background:linear-gradient(135deg, #111 0%, rgba(0,255,90,0.02) 100%);border-radius:24px;padding:32px;margin-bottom:24px;border:1px solid #222;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                <h3 style="margin:0 0 20px;color:#fff;font-size:20px;font-weight:700;">История операций</h3>
                <div id="operations-history" style="color:#888;font-size:14px;">
                    Операций пока нет
                </div>
            </div>

            <!-- Настройки биржи -->
            <div style="background:rgba(17,17,17,0.6);border-radius:20px;padding:28px;margin-bottom:24px;border:1px solid rgba(255,255,255,0.05);box-shadow:0 8px 32px rgba(0,0,0,0.3);backdrop-filter:blur(20px);">
                <h3 style="margin:0 0 24px;color:#fff;font-size:20px;font-weight:700;letter-spacing:-0.5px;">Настройки</h3>

                <div style="margin-bottom:20px;">
                    <div style="color:#999;font-size:12px;margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Режим графика</div>
                    <select id="chart-mode" style="width:100%;background:rgba(255,255,255,0.03);color:#fff;border:1px solid rgba(255,255,255,0.08);
                        border-radius:12px;padding:14px 16px;font-size:15px;outline:none;cursor:pointer;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);font-weight:500;"
                        onfocus="this.style.borderColor='rgba(0,255,90,0.5)';this.style.background='rgba(0,255,90,0.05)';this.style.boxShadow='0 0 0 4px rgba(0,255,90,0.08)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.03)';this.style.boxShadow='none'">
                        <option value="candles">📊 Свечной график</option>
                        <option value="line">📈 Линейный график</option>
                    </select>
                </div>

                <div style="margin-bottom:20px;">
                    <div style="color:#999;font-size:12px;margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Тема интерфейса</div>
                    <select id="theme-mode" style="width:100%;background:rgba(255,255,255,0.03);color:#fff;border:1px solid rgba(255,255,255,0.08);
                        border-radius:12px;padding:14px 16px;font-size:15px;outline:none;cursor:pointer;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);font-weight:500;"
                        onfocus="this.style.borderColor='rgba(0,255,90,0.5)';this.style.background='rgba(0,255,90,0.05)';this.style.boxShadow='0 0 0 4px rgba(0,255,90,0.08)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.03)';this.style.boxShadow='none'">
                        <option value="dark">🌙 Тёмная</option>
                        <option value="light">☀️ Светлая</option>
                    </select>
                </div>

                <div style="border-top:1px solid rgba(255,255,255,0.05);padding-top:20px;">
                    <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:14px 16px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);"
                        onmouseover="this.style.background='rgba(0,255,90,0.05)';this.style.borderColor='rgba(0,255,90,0.2)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.02)';this.style.borderColor='rgba(255,255,255,0.05)'">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:40px;height:40px;background:rgba(0,255,90,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">🔔</div>
                            <div>
                                <div style="color:#fff;font-size:15px;font-weight:600;margin-bottom:2px;">Звуковые уведомления</div>
                                <div style="color:#666;font-size:12px;">Включить звук для сделок</div>
                            </div>
                        </div>
                        <input type="checkbox" id="sound-enabled"
                            style="width:48px;height:28px;appearance:none;background:rgba(255,255,255,0.1);border-radius:14px;cursor:pointer;position:relative;transition:all 0.3s ease;border:none;outline:none;"
                            onchange="this.style.background=this.checked?'#00ff5a':'rgba(255,255,255,0.1)'" />
                    </label>
                </div>
            </div>

            <!-- Кнопка выхода из аккаунта -->
            <div style="background:linear-gradient(135deg, #111 0%, rgba(240,90,80,0.02) 100%);border-radius:24px;padding:32px;margin-bottom:24px;border:1px solid #222;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                <button id="logout-button"
                    style="width:100%;background:linear-gradient(135deg, #f05a50 0%, #ff4976 100%);color:#fff;border:none;border-radius:20px;padding:20px;
                    font-size:18px;font-weight:700;cursor:pointer;transition:all 0.3s ease;display:flex;
                    align-items:center;justify-content:center;gap:12px;position:relative;overflow:hidden;box-shadow:0 4px 15px rgba(240,90,80,0.3);"
                    onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 25px rgba(240,90,80,0.4)'"
                    onmouseout="this.style.transform='';this.style.boxShadow='0 4px 15px rgba(240,90,80,0.3)'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    Выйти из аккаунта
                </button>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="deposit-modal"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);backdrop-filter:blur(20px);z-index:1001;animation:fadeIn 0.3s ease;">
        <div
            style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:480px;background:rgba(15,15,15,0.98);border-radius:20px;box-shadow:0 24px 48px rgba(0,0,0,0.7), 0 0 1px rgba(0,255,90,0.3);max-height:90vh;overflow:hidden;border:1px solid rgba(255,255,255,0.05);">
            <div
                style="padding:28px 32px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h3 style="margin:0 0 4px 0;color:#fff;font-size:22px;font-weight:700;letter-spacing:-0.5px;">Пополнение баланса</h3>
                    <p style="margin:0;color:#666;font-size:13px;font-weight:500;">Выберите способ оплаты</p>
                </div>
                <button onclick="document.getElementById('deposit-modal').style.display='none'"
                    style="background:rgba(255,255,255,0.05);border:none;color:#888;cursor:pointer;padding:10px;width:40px;height:40px;font-size:20px;border-radius:10px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);display:flex;align-items:center;justify-content:center;"
                    onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)';this.style.color='#fff';this.style.transform='rotate(90deg)'"
                    onmouseout="this.style.backgroundColor='rgba(255,255,255,0.05)';this.style.color='#888';this.style.transform='rotate(0deg)'">×</button>
            </div>
            <div style="padding:32px;overflow-y:auto;max-height:calc(90vh - 180px);">
                <div style="margin-bottom:28px;">
                    <label style="display:block;color:#999;font-size:13px;margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Сумма пополнения</label>
                    <div style="position:relative;">
                        <input type="number" id="deposit-amount" min="1" step="0.01"
                            placeholder="0.00"
                            style="background:rgba(255,255,255,0.03);color:#fff;border-radius:14px;padding:18px 20px;padding-right:80px;border:1px solid rgba(255,255,255,0.08);width:100%;outline:none;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);font-size:18px;font-weight:600;"
                            onfocus="this.style.borderColor='rgba(0,255,90,0.5)';this.style.background='rgba(0,255,90,0.05)';this.style.boxShadow='0 0 0 4px rgba(0,255,90,0.08)'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.03)';this.style.boxShadow='none'">
                        <span style="position:absolute;right:20px;top:50%;transform:translateY(-50%);color:#666;font-size:14px;font-weight:700;pointer-events:none;">USDT</span>
                    </div>
                </div>

                <div style="margin-bottom:28px;">
                    <label style="display:block;color:#999;font-size:13px;margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Способ оплаты</label>
                    <div id="payment-methods" style="display:flex;flex-direction:column;gap:10px;">
                        <!-- Payment methods will be loaded here -->
                    </div>
                </div>

                <div id="payment-details" style="margin-bottom:28px;display:none;">
                    <label style="display:block;color:#999;font-size:13px;margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Реквизиты для оплаты</label>
                    <div id="payment-instructions"
                        style="background:rgba(0,255,90,0.05);border-radius:14px;padding:20px;color:#fff;font-size:14px;border:1px solid rgba(0,255,90,0.2);line-height:1.6;">
                        <!-- Payment instructions will be loaded here -->
                    </div>
                </div>

                <button id="confirm-deposit-btn"
                    style="width:100%;background:#00ff5a;color:#0a0a0a;border:none;border-radius:14px;padding:18px;
                    font-size:15px;font-weight:700;cursor:pointer;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);text-transform:uppercase;letter-spacing:1px;position:relative;overflow:hidden;box-shadow:0 8px 20px rgba(0,255,90,0.25);"
                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 12px 28px rgba(0,255,90,0.35)';this.style.background='#00e54d'"
                    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 20px rgba(0,255,90,0.25)';this.style.background='#00ff5a'">
                    Подтвердить пополнение
                </button>
            </div>
        </div>
    </div>

    <!-- Deposit Confirmation Modal -->
    <div id="deposit-confirmation-modal"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);backdrop-filter:blur(10px);z-index:1002;">
        <div
            style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;background:linear-gradient(135deg, #1a1a1a 0%, rgba(0,255,90,0.02) 100%);border-radius:24px;box-shadow:0 20px 40px rgba(0,0,0,0.6), 0 0 30px rgba(0,255,90,0.1);text-align:center;padding:40px;border:1px solid #333;">
            <div style="font-size:64px;margin-bottom:24px;animation:pulse 2s infinite;">⏳</div>
            <h3 style="margin:0 0 20px;color:#fff;font-size:24px;font-weight:700;">Ожидайте подтверждение</h3>
            <p style="color:#888;margin:0 0 24px;font-size:16px;line-height:1.5;">
                Ваш запрос на пополнение находится в обработке. 
                Баланс будет начислен в ближайшее время.
            </p>
            <button onclick="document.getElementById('deposit-confirmation-modal').style.display='none'"
                style="background:linear-gradient(135deg, #1a1a1a 0%, rgba(0,255,90,0.05) 100%);color:#00ff5a;border:1px solid #333;border-radius:18px;padding:16px 32px;
                font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s ease;"
                onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(0,255,90,0.2)'"
                onmouseout="this.style.transform='';this.style.boxShadow='none'">
                Закрыть
            </button>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawal-modal"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px);z-index:1001;">
        <div
            style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:#1a1a1a;border-radius:20px;box-shadow:0 0 20px rgba(0,0,0,0.5);max-height:90vh;overflow-y:auto;">
            <div
                style="padding:20px;border-bottom:1px solid #2a2a2a;display:flex;justify-content:space-between;align-items:center;">
                <h3 style="margin:0;color:#fff;font-size:18px;">Вывод средств</h3>
                <button onclick="document.getElementById('withdrawal-modal').style.display='none'"
                    style="background:none;border:none;color:#888;cursor:pointer;padding:5px;font-size:20px;">×</button>
            </div>
            <div style="padding:20px;">
                <div style="margin-bottom:20px;">
                    <label class="block text-[#888] text-sm mb-2">Сумма вывода (USDT)</label>
                    <input type="number" id="withdrawal-amount" min="1" step="0.01"
                        class="input-field"
                        placeholder="Введите сумму"
                        style="background:#111;color:#fff;border-radius:15px;padding:12px;border:1px solid #333;width:100%;outline:none;">
                </div>

                <div style="margin-bottom:20px;">
                    <label class="block text-[#888] text-sm mb-2">Способ вывода</label>
                    <select id="withdrawal-method" class="input-field"
                        style="background:#111;color:#fff;border-radius:15px;padding:12px;border:1px solid #333;width:100%;outline:none;">
                        <option value="">Выберите способ вывода</option>
                        <option value="bank">Банковский перевод</option>
                        <option value="crypto">Криптовалюта</option>
                        <option value="qiwi">Qiwi</option>
                        <option value="yoomoney">YooMoney</option>
                    </select>
                </div>

                <div style="margin-bottom:20px;">
                    <label class="block text-[#888] text-sm mb-2">Реквизиты получателя</label>
                    <input type="text" id="withdrawal-details"
                        class="input-field"
                        placeholder="Введите реквизиты получателя"
                        style="background:#111;color:#fff;border-radius:15px;padding:12px;border:1px solid #333;width:100%;outline:none;">
                </div>

                <button id="confirm-withdrawal-btn"
                    style="width:100%;background:#f05a50;color:#fff;border:none;border-radius:15px;padding:16px;
                    font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s ease;text-transform:uppercase;letter-spacing:1px;"
                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 15px rgba(240,90,80,0.3)'"
                    onmouseout="this.style.transform='';this.style.boxShadow=''">
                    Подтвердить вывод
                </button>
            </div>
        </div>
    </div>

    <!-- First Withdrawal Modal -->
    <div id="first-withdrawal-modal"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px);z-index:1002;">
        <div
            style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;background:#1a1a1a;border-radius:20px;box-shadow:0 0 20px rgba(0,0,0,0.5);text-align:center;padding:30px;">
            <div style="font-size:48px;margin-bottom:20px;">⚠️</div>
            <h3 style="margin:0 0 15px;color:#fff;font-size:20px;">Первый вывод средств</h3>
            <p style="color:#888;margin:0 0 20px;">
                Для первого вывода средств, пожалуйста, обратитесь в техническую поддержку.
            </p>
            <a href="https://t.me/OKXSupport_Official" target="_blank"
                style="display:inline-block;background:#0088cc;color:#fff;border-radius:15px;padding:12px 24px;
                font-size:16px;text-decoration:none;transition:all 0.3s ease;margin-bottom:15px;">
                Написать в Telegram
            </a>
            <button onclick="document.getElementById('first-withdrawal-modal').style.display='none'"
                style="background:#1a1a1a;color:#00ff5a;border:1px solid #333;border-radius:15px;padding:12px 24px;
                font-size:16px;cursor:pointer;transition:all 0.3s ease;">
                Закрыть
            </button>
        </div>
    </div>

    <nav>
        <div class="nav-item active" id="nav-coins">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="12" cy="12" r="9" />
                <path d="M14.8 9A2 2 0 0 0 13 8h-2a2 2 0 0 0 0 4h2a2 2 0 0 1 0 4h-2a2 2 0 0 1-1.8-1" />
                <path d="M12 6v2m0 8v2" />
            </svg>
            Монеты
        </div>
        <div class="nav-item" id="nav-trading">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M3 3v18h18" />
                <path d="M8 17l3-3 2 2 4-4" />
                <circle cx="19" cy="5" r="2" />
            </svg>
            Торговля
        </div>
        <div class="nav-item" id="nav-settings">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="12" cy="12" r="3" />
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
            </svg>
            Настройки
        </div>
    </nav>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // Backend API URL (serving from same server)
        const API_BASE_URL = '/api';
        
        // Initialize WebSocket connection
        const socket = io();
        
        // Get Telegram username from localStorage
        const tgUsername = localStorage.getItem('tgUsername');
        
        // Redirect to login if not authenticated
        if (!tgUsername) {
            window.location.href = '/login.html';
        }
        
        // Update username in settings
        document.getElementById('settings-username').textContent = tgUsername;
        document.getElementById('tg-username').value = tgUsername;
        
        // Connect to WebSocket
        socket.on('connect', function() {
            console.log('Connected to WebSocket');
            // Request initial balance
            socket.emit('request_balance', { telegram_username: tgUsername });
        });
        
        // Handle balance updates from WebSocket
        socket.on('balance_update', function(data) {
            if (data.telegram_username === tgUsername) {
                document.getElementById('balance').textContent = data.balance.toFixed(2);
                localStorage.setItem('balance', data.balance);
            }
        });
        
        // Fetch initial balance from API
        function fetchInitialBalance() {
            fetch(`${API_BASE_URL}/balance/${tgUsername}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('balance').textContent = data.balance.toFixed(2);
                    localStorage.setItem('balance', data.balance);
                })
                .catch(error => {
                    console.error('Error fetching balance:', error);
                    // Fallback to localStorage
                    const storedBalance = localStorage.getItem('balance');
                    if (storedBalance) {
                        document.getElementById('balance').textContent = parseFloat(storedBalance).toFixed(2);
                    }
                });
        }
        
        // Call fetchInitialBalance when page loads
        fetchInitialBalance();
        
        // Load coin prices from API
        loadCoinPrices();
        
        // Update prices every 30 seconds
        setInterval(loadCoinPrices, 30000);
        
        // Load operations history
        loadOperationsHistory();
        
        // Function to load coin prices from API
        async function loadCoinPrices() {
            try {
                const response = await fetch('/api/coin-prices');
                const data = await response.json();
                
                if (data.success && data.prices) {
                    // Update coins array with real prices
                    coins = coins.map(coin => {
                        const priceData = data.prices[coin.symbol];
                        if (priceData) {
                            return {
                                ...coin,
                                price: priceData.formatted_price,
                                change: priceData.formatted_change
                            };
                        }
                        return coin;
                    });
                    
                    // Re-render the coins list with updated prices
                    renderCoinsList();
                }
            } catch (error) {
                console.error('Error loading coin prices:', error);
                // Keep the loading state if API fails
            }
        }
        
        // Function to load operations history
        async function loadOperationsHistory() {
            try {
                const storedTelegram = localStorage.getItem('telegram_username');
                if (!storedTelegram) {
                    document.getElementById('operations-history').innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Войдите в аккаунт для просмотра истории</div>';
                    return;
                }
                
                const response = await fetch(`/api/operations/${storedTelegram}`);
                const data = await response.json();
                
                if (data.success && data.operations) {
                    renderOperationsHistory(data.operations);
                } else {
                    document.getElementById('operations-history').innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Ошибка загрузки истории</div>';
                }
            } catch (error) {
                console.error('Error loading operations history:', error);
                document.getElementById('operations-history').innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Ошибка загрузки истории</div>';
            }
        }
        
        // Function to render operations history
        function renderOperationsHistory(operations) {
            const operationsContainer = document.getElementById('operations-history');
            
            if (!operations || operations.length === 0) {
                operationsContainer.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Операций пока нет</div>';
                return;
            }
            
            const operationsHTML = operations.map(operation => {
                const date = new Date(operation.timestamp).toLocaleString('ru-RU');
                const statusColor = getStatusColor(operation.status, operation.result);
                const statusText = getStatusText(operation.status, operation.result);
                const amountColor = operation.type === 'bet' ? (operation.result === 'win' ? '#00ff5a' : '#ff4976') : '#00ff5a';
                
                return `
                    <div style="background:rgba(255,255,255,0.02);border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.05);transition:all 0.3s ease;"
                         onmouseover="this.style.background='rgba(255,255,255,0.05)';this.style.borderColor='rgba(0,255,90,0.2)'"
                         onmouseout="this.style.background='rgba(255,255,255,0.02)';this.style.borderColor='rgba(255,255,255,0.05)'">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div style="color:#fff;font-weight:600;font-size:14px;">${operation.description}</div>
                            <div style="color:${amountColor};font-weight:700;font-size:16px;">${operation.amount} USDT</div>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="color:#999;font-size:12px;">${date}</div>
                            <div style="color:${statusColor};font-size:12px;font-weight:600;padding:4px 8px;border-radius:6px;background:rgba(255,255,255,0.05);">
                                ${statusText}
                            </div>
                        </div>
                        ${operation.reward > 0 ? `<div style="color:#00ff5a;font-size:12px;margin-top:4px;">Выигрыш: +${operation.reward} USDT</div>` : ''}
                    </div>
                `;
            }).join('');
            
            operationsContainer.innerHTML = operationsHTML;
        }
        
        // Helper function to get status color
        function getStatusColor(status, result) {
            if (status === 'completed') {
                return result === 'win' ? '#00ff5a' : '#ff4976';
            } else if (status === 'active') {
                return '#ffa500';
            } else if (status === 'approved') {
                return '#00ff5a';
            } else if (status === 'pending') {
                return '#ffa500';
            } else if (status === 'rejected') {
                return '#ff4976';
            }
            return '#999';
        }
        
        // Helper function to get status text
        function getStatusText(status, result) {
            if (status === 'completed') {
                return result === 'win' ? 'Выигрыш' : 'Проигрыш';
            } else if (status === 'active') {
                return 'Активна';
            } else if (status === 'approved') {
                return 'Одобрено';
            } else if (status === 'pending') {
                return 'Ожидает';
            } else if (status === 'rejected') {
                return 'Отклонено';
            }
            return status;
        }
        
        // Монеты с логотипами (базовая структура, цены будут загружены из API)
        let coins = [
            { symbol: 'BTCUSDT', name: 'Bitcoin', color: '#f7931a', price: 'Loading...', change: 'Loading...', logo: '₿' },
            { symbol: 'ETHUSDT', name: 'Ethereum', color: '#627eea', price: 'Loading...', change: 'Loading...', logo: 'Ξ' },
            { symbol: 'SOLUSDT', name: 'Solana', color: '#9945ff', price: 'Loading...', change: 'Loading...', logo: '◎' },
            { symbol: 'XRPUSDT', name: 'Ripple', color: '#23292F', price: 'Loading...', change: 'Loading...', logo: '✕' },
            { symbol: 'ADAUSDT', name: 'Cardano', color: '#0033AD', price: 'Loading...', change: 'Loading...', logo: '₳' },
            { symbol: 'DOGEUSDT', name: 'Dogecoin', color: '#BA9F33', price: 'Loading...', change: 'Loading...', logo: 'Ð' },
            { symbol: 'TONUSDT', name: 'Toncoin', color: '#2e6de7', price: 'Loading...', change: 'Loading...', logo: '₸' },
            { symbol: 'DOTUSDT', name: 'Polkadot', color: '#E6007A', price: 'Loading...', change: 'Loading...', logo: '●' },
            { symbol: 'MATICUSDT', name: 'Polygon', color: '#8247E5', price: 'Loading...', change: 'Loading...', logo: '⬟' },
            { symbol: 'SHIBUSDT', name: 'Shiba Inu', color: '#f05a50', price: 'Loading...', change: 'Loading...', logo: '🐕' },
            { symbol: 'AVAXUSDT', name: 'Avalanche', color: '#E84142', price: 'Loading...', change: 'Loading...', logo: '🔺' },
            { symbol: 'TRXUSDT', name: 'TRON', color: '#FF0013', price: 'Loading...', change: 'Loading...', logo: 'T' },
            { symbol: 'LINKUSDT', name: 'Chainlink', color: '#2A5ADA', price: 'Loading...', change: 'Loading...', logo: '🔗' },
            { symbol: 'ATOMUSDT', name: 'Cosmos', color: '#2E3148', price: 'Loading...', change: 'Loading...', logo: '⚛' },
            { symbol: 'UNIUSDT', name: 'Uniswap', color: '#FF007A', price: 'Loading...', change: 'Loading...', logo: '🦄' },
            { symbol: 'NEARUSDT', name: 'NEAR Protocol', color: '#000000', price: 'Loading...', change: 'Loading...', logo: 'N' },
            { symbol: 'APTUSDT', name: 'Aptos', color: '#277FF2', price: 'Loading...', change: 'Loading...', logo: 'A' },
            { symbol: 'OPUSDT', name: 'Optimism', color: '#FF0420', price: 'Loading...', change: 'Loading...', logo: 'O' },
            { symbol: 'INJUSDT', name: 'Injective', color: '#17EAE9', price: 'Loading...', change: 'Loading...', logo: 'I' },
            { symbol: 'SUIUSDT', name: 'Sui', color: '#6fbcf0', price: 'Loading...', change: 'Loading...', logo: 'S' }
        ];

        // Страницы
        const pageInstruments = document.getElementById('page-instruments');
        const pageTrading = document.getElementById('page-trading');
        const pageTrades = document.getElementById('page-trades');
        const navCoins = document.getElementById('nav-coins');
        const navTrading = document.getElementById('nav-trading');
        const navSettings = document.getElementById('nav-settings');
        const tabInstruments = document.getElementById('tab-instruments');
        const tabTrades = document.getElementById('tab-trades');

        // Переключение страниц
        function showPage(page) {
            pageInstruments.style.display = page === 'instruments' ? '' : 'none';
            pageTrading.style.display = page === 'trading' ? '' : 'none';
            pageTrades.style.display = page === 'trades' ? '' : 'none';
            document.getElementById('page-settings').style.display = page === 'settings' ? '' : 'none';
            navCoins.classList.toggle('active', page === 'instruments');
            navTrading.classList.toggle('active', page === 'trading');
            navSettings.classList.toggle('active', page === 'settings');

            // Обновляем состояние нижней навигации
            if (page === 'instruments' || page === 'trades') {
                navCoins.classList.add('active');
                navTrading.classList.remove('active');
                navSettings.classList.remove('active');
            }

            // Обновляем состояние табов
            if (page === 'instruments') {
                document.querySelector('#page-instruments .tab[id="tab-instruments"]').classList.add('active');
                document.querySelector('#page-instruments .tab[id="tab-trades"]').classList.remove('active');
                if (document.querySelector('#page-trades .tab[id="tab-instruments"]')) {
                    document.querySelector('#page-trades .tab[id="tab-instruments"]').classList.remove('active');
                    document.querySelector('#page-trades .tab[id="tab-trades"]').classList.add('active');
                }
            } else if (page === 'trades') {
                document.querySelector('#page-trades .tab[id="tab-instruments"]').classList.remove('active');
                document.querySelector('#page-trades .tab[id="tab-trades"]').classList.add('active');
                if (document.querySelector('#page-instruments .tab[id="tab-instruments"]')) {
                    document.querySelector('#page-instruments .tab[id="tab-instruments"]').classList.add('active');
                    document.querySelector('#page-instruments .tab[id="tab-trades"]').classList.remove('active');
                }
            }
        }

        navCoins.onclick = () => showPage('instruments');
        navTrading.onclick = () => showPage('trading');
        navSettings.onclick = () => showPage('settings');

        // Обработчики для табов на всех страницах
        document.querySelectorAll('.tab[id="tab-instruments"]').forEach(tab => {
            tab.onclick = () => showPage('instruments');
        });
        document.querySelectorAll('.tab[id="tab-trades"]').forEach(tab => {
            tab.onclick = () => showPage('trades');
        });

        // Рендеринг списка монет
        function renderCoinsList() {
            const coinList = document.getElementById('coin-list');
            coinList.innerHTML = coins.map(coin => `
                <div class="coin" data-symbol="${coin.symbol}">
                    <div class="coin-info">
                        <div class="coin-icon" style="--coin-color: ${coin.color};">
                            ${coin.logo}
                        </div>
                        <div>
                            <div class="coin-name">${coin.symbol}</div>
                            <div class="coin-symbol">${coin.name}</div>
                        </div>
                    </div>
                    <div class="coin-price">
                        <div class="price">$${coin.price}</div>
                        <div class="change ${coin.change.startsWith('+') ? 'positive' : 'negative'}">${coin.change}</div>
                    </div>
                </div>
            `).join('');

            // При клике на монету — открыть торговлю по ней
            document.querySelectorAll('#coin-list .coin').forEach(coinEl => {
                coinEl.onclick = function () {
                    const symbol = coinEl.getAttribute('data-symbol');
                    currentCoin = coins.find(c => c.symbol === symbol);
                    updateTradingPage();
                    showPage('trading');
                };
            });
        }

        // TradingView chart
        let currentCoin = coins[0];
        let tvWidget;
        function renderTradingView(symbol) {
            if (tvWidget) {
                tvWidget.remove();
            }
            tvWidget = new TradingView.widget({
                symbol: symbol.replace('USDT', 'USD'),
                interval: '15',
                container_id: 'tradingview-chart',
                width: '100%',
                height: 350,
                theme: 'dark',
                style: 1,
                locale: 'ru',
                toolbar_bg: '#111',
                enable_publishing: false,
                hide_top_toolbar: false,
                hide_legend: false,
                allow_symbol_change: false,
                details: true,
                studies: [],
            });
        }

        // Инициализация страницы торговли
        function updateTradingPage() {
            document.getElementById('trading-coin-name').textContent = currentCoin.symbol;
            renderTradingView(currentCoin.symbol);
        }

        // Модальное окно выбора монеты
        function renderModalCoins() {
            const modalList = document.getElementById('modal-coins-list');
            modalList.innerHTML = '';
            coins.forEach(coin => {
                const coinEl = document.createElement('div');
                coinEl.style = 'display:flex;align-items:center;padding:16px;border-bottom:1px solid #2a2a2a;cursor:pointer;transition:all 0.3s ease;';
                coinEl.innerHTML = `
                    <div style="width:40px;height:40px;border-radius:50%;background-color:${coin.color};margin-right:15px;"></div>
                    <div>
                        <div style="font-weight:600;color:#fff;font-size:16px;">${coin.symbol}</div>
                        <div style="color:#888;font-size:13px;margin-top:4px;">${coin.name}</div>
                    </div>
                    <div style="margin-left:auto;text-align:right;">
                        <div style="color:#fff;font-weight:bold;">${coin.price}</div>
                        <div style="color:#00ff5a;font-size:13px;margin-top:4px;">${coin.change}</div>
                    </div>
                `;
                coinEl.onmouseover = () => coinEl.style.backgroundColor = 'rgba(255,255,255,0.05)';
                coinEl.onmouseout = () => coinEl.style.backgroundColor = '';
                coinEl.onclick = () => {
                    currentCoin = coin;
                    updateTradingPage();
                    document.getElementById('coin-modal').style.display = 'none';
                };
                modalList.appendChild(coinEl);
            });
        }

        // Открытие модального окна при клике на кнопку смены монеты
        document.getElementById('switch-coin').onclick = function () {
            document.getElementById('coin-modal').style.display = 'block';
            renderModalCoins();
        };

        // При клике на монету — открыть торговлю по ней
        document.querySelectorAll('#coin-list .coin').forEach(coinEl => {
            coinEl.onclick = function () {
                const symbol = coinEl.getAttribute('data-symbol');
                currentCoin = coins.find(c => c.symbol === symbol);
                updateTradingPage();
                showPage('trading');
            };
        });

        // Выбор направления
        let direction = 'long';
        document.querySelectorAll('.direction-btn').forEach(btn => {
            btn.onclick = function () {
                direction = btn.getAttribute('data-dir');
                document.querySelectorAll('.direction-btn').forEach(b => {
                    b.style.background = '#1a1a1a';
                    b.style.borderColor = '#333';
                    b.style.boxShadow = 'none';
                });
                if (direction === 'long') {
                    btn.style.background = '#00ff5a15';
                    btn.style.borderColor = '#00ff5a';
                    btn.style.boxShadow = '0 0 10px rgba(0,255,90,0.2)';
                } else {
                    btn.style.background = '#f05a5015';
                    btn.style.borderColor = '#f05a50';
                    btn.style.boxShadow = '0 0 10px rgba(240,90,80,0.2)';
                }
            };
            // Установка начального состояния для Long
            if (btn.getAttribute('data-dir') === 'long') {
                btn.style.background = '#00ff5a15';
                btn.style.borderColor = '#00ff5a';
                btn.style.boxShadow = '0 0 10px rgba(0,255,90,0.2)';
            }
        });

        // Выбор времени
        let betTime = 1;
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.onclick = function () {
                betTime = parseInt(btn.getAttribute('data-time'));
                document.querySelectorAll('.time-btn').forEach(b => {
                    b.style.background = '#1a1a1a';
                    b.style.borderColor = '#333';
                    b.style.color = '#fff';
                    b.style.boxShadow = 'none';
                });
                btn.style.background = '#00ff5a';
                btn.style.borderColor = '#00ff5a';
                btn.style.color = '#111';
                btn.style.boxShadow = '0 0 10px rgba(0,255,90,0.3)';
            };
            // Установка начального состояния для 1 мин
            if (btn.getAttribute('data-time') === '1') {
                btn.style.background = '#00ff5a';
                btn.style.borderColor = '#00ff5a';
                btn.style.color = '#111';
                btn.style.boxShadow = '0 0 10px rgba(0,255,90,0.3)';
            }
        });

        // Баланс
        let balance = 100;
        function updateBalance(val) {
            balance = val;
            document.getElementById('balance').textContent = balance;
        }

        // Сделки - загрузка из localStorage
        let trades = [];
        let lastRenderTime = 0;
        let renderThrottle = 1000; // Минимальный интервал между рендерами (1 секунда)
        let tradeUpdateQueue = new Set();
        
        // Загрузка сделок из localStorage при загрузке страницы
        function loadTrades() {
            const savedTrades = localStorage.getItem('activeTrades');
            if (savedTrades) {
                try {
                    trades = JSON.parse(savedTrades);
                    // Обновляем таймеры на основе времени создания
                    const now = Date.now();
                    trades = trades.filter(trade => {
                        const elapsed = Math.floor((now - trade.createdAt) / 1000);
                        const totalTime = trade.time * 60;
                        trade.timer = Math.max(0, totalTime - elapsed);
                        return trade.timer >= 0 || trade.status === 'completed';
                    });
                    saveTrades();
                } catch (e) {
                    console.error('Error loading trades:', e);
                    trades = [];
                }
            }
        }
        
        // Сохранение сделок в localStorage с debouncing
        let saveTimeout;
        function saveTrades() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem('activeTrades', JSON.stringify(trades));
            }, 500);
        }
        
        // Оптимизированный рендеринг сделок
        function renderTrades() {
            const now = Date.now();
            if (now - lastRenderTime < renderThrottle) {
                return; // Пропускаем рендер если прошло мало времени
            }
            lastRenderTime = now;
            
            const tradesList = document.getElementById('trades-list');
            if (!tradesList) return;
            
            // Используем DocumentFragment для оптимизации
            const fragment = document.createDocumentFragment();
            
            if (trades.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style = 'color:#888;padding:16px;text-align:center;';
                emptyDiv.textContent = 'Нет активных сделок';
                fragment.appendChild(emptyDiv);
            } else {
                trades.forEach((trade, idx) => {
                    const tradeDiv = createTradeElement(trade, idx);
                    fragment.appendChild(tradeDiv);
                });
            }
            
            // Очищаем и добавляем все элементы за одну операцию
            tradesList.innerHTML = '';
            tradesList.appendChild(fragment);
        }
        
        // Создание элемента сделки с оптимизацией
        function createTradeElement(trade, idx) {
            const tradeDiv = document.createElement('div');
            const isCompleted = trade.timer <= 0 && trade.status === 'completed';
            const isWaiting = trade.timer <= 0 && trade.status === 'active';
            const isProcessing = trade.status === 'processing';
            
            // Определяем CSS классы для статуса
            let statusClass = 'trade-status-active';
            if (isCompleted) statusClass = 'trade-status-completed';
            else if (isProcessing) statusClass = 'trade-status-processing';
            
            tradeDiv.className = 'trade-item';
            tradeDiv.style = `background:${isCompleted ? 'rgba(0,255,90,0.1)' : '#1a1a1a'};border-radius:15px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid ${isCompleted ? '#00ff5a' : '#222'};transition:all 0.3s ease;`;
            
            // Оптимизированный HTML с использованием CSS классов
            tradeDiv.innerHTML = `
                <div>
                    <div style="font-weight:600;color:#fff;font-size:16px;">${trade.symbol}</div>
                    <div style="color:#888;font-size:13px;">${trade.direction === 'long' ? 'Long' : 'Short'} / ${trade.time} мин / ${trade.amount} USDT</div>
                    ${isCompleted ? `<div style="color:#00ff5a;font-size:12px;margin-top:4px;">✓ Выплата: +${(trade.reward || 0).toFixed(2)} USDT</div>` : ''}
                </div>
                <div style="text-align:right;">
                    <div class="${statusClass}" style="font-size:15px;font-weight:600;">
                        ${trade.timer > 0 ? formatTimer(trade.timer) : isCompleted ? 'Завершено' : isProcessing ? 'Обработка...' : 'Ожидание...'}
                    </div>
                    ${isCompleted ? `<button onclick="removeTrade(${idx})" style="margin-top:8px;background:#1a1a1a;color:#666;border:1px solid #333;border-radius:8px;padding:4px 12px;font-size:12px;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='#1a1a1a'">Удалить</button>` : ''}
                </div>
            `;
            
            return tradeDiv;
        }
        
        // Функция удаления завершенной сделки
        window.removeTrade = function(idx) {
            if (idx >= 0 && idx < trades.length) {
                trades.splice(idx, 1);
                saveTrades();
                renderTrades();
            }
        }

        function formatTimer(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // Оптимизированный таймер для сделок
        let timerInterval;
        function startTradeTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                let hasChanges = false;
                let needsSave = false;
                
                trades.forEach((trade, idx) => {
                    if (trade.timer > 0 && trade.status === 'active') {
                        trade.timer--;
                        hasChanges = true;
                        needsSave = true;
                        
                        // Когда таймер достигает 0, отправляем запрос на сервер
                        if (trade.timer === 0) {
                            processTradeCompletion(trade);
                        }
                    }
                });
                
                // Обновляем UI только если есть изменения
                if (hasChanges) {
                    renderTrades();
                }
                if (needsSave) {
                    saveTrades();
                }
            }, 1000);
        }
        
        // Останавливаем таймер если нет активных сделок
        function checkAndStopTimer() {
            const hasActiveTrades = trades.some(trade => trade.timer > 0 && trade.status === 'active');
            if (!hasActiveTrades && timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        // Обработка завершения сделки с оптимизацией
        async function processTradeCompletion(trade) {
            // Устанавливаем статус "обработка"
            trade.status = 'processing';
            saveTrades();
            renderTrades();
            
            try {
                const response = await fetch(`${API_BASE_URL}/complete-bet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram: tgUsername,
                        trade_id: trade.id,
                        symbol: trade.symbol,
                        direction: trade.direction,
                        amount: trade.amount,
                        time: trade.time
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Обновляем статус сделки
                    trade.status = 'completed';
                    trade.result = data.result; // 'win' или 'loss'
                    trade.reward = data.reward || 0;
                    
                    // Обновляем баланс
                    const balanceElement = document.getElementById('balance');
                    if (balanceElement) {
                        balanceElement.textContent = data.new_balance.toFixed(2);
                        localStorage.setItem('balance', data.new_balance);
                    }
                    
                    // Показываем уведомление
                    if (data.result === 'win') {
                        showNotification(`🎉 Поздравляем! Вы выиграли ${data.reward.toFixed(2)} USDT!`, 'success');
                    } else {
                        showNotification(`Сделка завершена. Попробуйте еще раз!`, 'info');
                    }
                    
                    saveTrades();
                    renderTrades();
                    
                    // Обновляем историю операций
                    loadOperationsHistory();
                    
                    // Проверяем нужно ли остановить таймер
                    checkAndStopTimer();
                } else {
                    console.error('Error completing trade:', data.message);
                    // В случае ошибки возвращаем статус обратно
                    trade.status = 'active';
                    trade.timer = 1; // Даем еще одну секунду
                    saveTrades();
                    renderTrades();
                }
            } catch (error) {
                console.error('Error processing trade completion:', error);
                // В случае ошибки возвращаем статус обратно
                trade.status = 'active';
                trade.timer = 1; // Даем еще одну секунду
                saveTrades();
                renderTrades();
            }
        }
        
        // Функция показа уведомлений с поддержкой разных типов
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            
            let backgroundColor, textColor, icon;
            switch (type) {
                case 'success':
                    backgroundColor = 'rgba(0,255,90,0.95)';
                    textColor = '#0a0a0a';
                    icon = '✓';
                    break;
                case 'error':
                    backgroundColor = 'rgba(255,73,118,0.95)';
                    textColor = '#fff';
                    icon = '✗';
                    break;
                case 'warning':
                    backgroundColor = 'rgba(255,165,0,0.95)';
                    textColor = '#0a0a0a';
                    icon = '⚠';
                    break;
                default:
                    backgroundColor = 'rgba(26,26,26,0.95)';
                    textColor = '#fff';
                    icon = 'ℹ';
            }
            
            notification.style = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${backgroundColor};
                color: ${textColor};
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                z-index: 10000;
                font-weight: 600;
                backdrop-filter: blur(10px);
                animation: slideIn 0.3s ease;
                max-width: 300px;
                border: 1px solid ${type === 'success' ? 'rgba(0,255,90,0.3)' : type === 'error' ? 'rgba(255,73,118,0.3)' : 'rgba(255,255,255,0.1)'};
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        // Добавляем CSS анимации для уведомлений
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Разместить ставку с оптимизацией
        document.getElementById('place-bet').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('bet-amount').value);
            const direction = document.querySelector('.direction-btn[style*="background: rgb(0, 255, 90)"]') ? 'long' : 'short';
            const time = parseInt(document.querySelector('.time-btn[style*="background: rgb(0, 255, 90)"]')?.getAttribute('data-time') || '1');
            
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму ставки', 'error');
                return;
            }
            
            // Get current balance
            const currentBalance = parseFloat(document.getElementById('balance').textContent);
            
            if (amount > currentBalance) {
                showNotification('Недостаточно средств на балансе', 'error');
                return;
            }
            
            // Блокируем кнопку на время обработки
            const button = this;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Обработка...';
            
            // Send bet to backend
            fetch(`${API_BASE_URL}/bet`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    telegram: tgUsername,
                    symbol: currentCoin.symbol,
                    amount: amount,
                    direction: direction,
                    time: time
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update balance display
                    const balanceElement = document.getElementById('balance');
                    if (balanceElement) {
                        balanceElement.textContent = data.new_balance.toFixed(2);
                        localStorage.setItem('balance', data.new_balance);
                    }
                    
                    // Add to trades
                    const trade = {
                        id: Date.now(),
                        symbol: currentCoin.symbol,
                        direction: direction,
                        time: time,
                        amount: amount,
                        timer: time * 60,
                        status: 'active',
                        createdAt: Date.now(), // Время создания для восстановления таймера
                        reward: 0
                    };
                    trades.push(trade);
                    saveTrades(); // Сохраняем сделки
                    renderTrades();
                    
                    // Запускаем таймер если он не запущен
                    if (!timerInterval) {
                        startTradeTimer();
                    }
                    
                    showNotification('✓ Ставка успешно размещена!', 'success');
                    
                    // Обновляем историю операций
                    loadOperationsHistory();
                } else {
                    showNotification('Ошибка размещения ставки: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error placing bet:', error);
                showNotification('Ошибка подключения к серверу', 'error');
            })
            .finally(() => {
                // Разблокируем кнопку
                button.disabled = false;
                button.textContent = originalText;
            });
        });

        // Настройки
        let settings = {
            tgUsername: localStorage.getItem('tgUsername') || '',
            chartMode: localStorage.getItem('chartMode') || 'candles',
            themeMode: localStorage.getItem('themeMode') || 'dark',
            soundEnabled: localStorage.getItem('soundEnabled') === 'true'
        };

        // Загрузка настроек
        document.getElementById('tg-username').value = settings.tgUsername;
        document.getElementById('chart-mode').value = settings.chartMode;
        document.getElementById('theme-mode').value = settings.themeMode;
        document.getElementById('sound-enabled').checked = settings.soundEnabled;

        // Сохранение настроек
        document.getElementById('tg-username').onchange = function () {
            settings.tgUsername = this.value;
            localStorage.setItem('tgUsername', this.value);
        };

        document.getElementById('chart-mode').onchange = function () {
            settings.chartMode = this.value;
            localStorage.setItem('chartMode', this.value);
            if (tvWidget) {
                tvWidget.remove();
                renderTradingView(currentCoin.symbol);
            }
        };

        document.getElementById('theme-mode').onchange = function () {
            settings.themeMode = this.value;
            localStorage.setItem('themeMode', this.value);
            // Здесь можно добавить логику смены темы
        };

        document.getElementById('sound-enabled').onchange = function () {
            settings.soundEnabled = this.checked;
            localStorage.setItem('soundEnabled', this.checked);
        };

        // История операций
        function addOperation(type, amount) {
            const date = new Date();
            const operations = JSON.parse(localStorage.getItem('operations') || '[]');
            operations.unshift({
                type,
                amount,
                date: date.toISOString()
            });
            localStorage.setItem('operations', JSON.stringify(operations));
            renderOperations();
        }

        function renderOperations() {
            const operations = JSON.parse(localStorage.getItem('operations') || '[]');
            const historyEl = document.getElementById('operations-history');

            if (operations.length === 0) {
                historyEl.innerHTML = 'Операций пока нет';
                return;
            }

            historyEl.innerHTML = operations.map(op => `
                <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #222;">
                    <div>
                        <div style="color:#fff;font-size:15px;">
                            ${op.type === 'deposit' ? 'Пополнение' : op.type === 'withdraw' ? 'Вывод' : 'Ставка'}
                        </div>
                        <div style="color:#666;font-size:13px;">
                            ${new Date(op.date).toLocaleString()}
                        </div>
                    </div>
                    <div style="color:${op.type === 'deposit' ? '#00ff5a' : '#f05a50'};font-weight:600;">
                        ${op.type === 'deposit' ? '+' : '-'}${op.amount} USDT
                    </div>
                </div>
            `).join('');
        }

        // Добавляем операцию в историю при размещении ставки
        /*
        const originalPlaceBet = document.getElementById('place-bet').onclick;
        document.getElementById('place-bet').onclick = function () {
            const amount = parseFloat(document.getElementById('bet-amount').value);
            if (!isNaN(amount) && amount > 0 && amount <= balance) {
                originalPlaceBet.call(this);
                addOperation('bet', amount);
            }
        };
        */

        // Deposit functionality
        document.getElementById('deposit-button').addEventListener('click', function() {
            document.getElementById('deposit-modal').style.display = 'block';
            loadPaymentMethods();
        });

        // Load payment methods
        function loadPaymentMethods() {
            fetch('/api/payment-methods')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('payment-methods');
                        container.innerHTML = '';

                        data.methods.forEach(method => {
                            const methodEl = document.createElement('div');
                            methodEl.style = 'background:#111;border-radius:15px;padding:15px;text-align:center;cursor:pointer;transition:all 0.3s ease;border:1px solid #222;';
                            methodEl.innerHTML = `
                                <div style="font-size:24px;margin-bottom:8px;">
                                    ${method.id === 'bank' ? '🏦' : 
                                      method.id === 'crypto' ? '₿' : 
                                      method.id === 'qiwi' ? '🟧' : 
                                      method.id === 'yoomoney' ? '🔵' : '💳'}
                                </div>
                                <div style="color:#fff;font-size:14px;">${method.name}</div>
                            `;
                            methodEl.onclick = () => selectPaymentMethod(method.id);
                            container.appendChild(methodEl);
                        });
                    } else {
                        console.error('Error loading payment methods:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading payment methods:', error);
                    // Fallback to static data
                    const paymentMethods = [
                        { id: 'bank', name: 'Банковский перевод', icon: '🏦' },
                        { id: 'crypto', name: 'Криптовалюта', icon: '₿' },
                        { id: 'qiwi', name: 'Qiwi', icon: '🟧' },
                        { id: 'yoomoney', name: 'YooMoney', icon: '🔵' }
                    ];

                    const container = document.getElementById('payment-methods');
                    container.innerHTML = '';

                    paymentMethods.forEach(method => {
                        const methodEl = document.createElement('div');
                        methodEl.style = 'background:#111;border-radius:15px;padding:15px;text-align:center;cursor:pointer;transition:all 0.3s ease;border:1px solid #222;';
                        methodEl.innerHTML = `
                            <div style="font-size:24px;margin-bottom:8px;">${method.icon}</div>
                            <div style="color:#fff;font-size:14px;">${method.name}</div>
                        `;
                        methodEl.onclick = () => selectPaymentMethod(method.id);
                        container.appendChild(methodEl);
                    });
                });
        }

        // Select payment method
        function selectPaymentMethod(methodId) {
            fetch(`/api/payment-methods/${methodId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const method = data.method;
                        let instructions = '';
                        
                        if (method.id === 'bank') {
                            // Parse bank details
                            const lines = method.details.split('\n');
                            instructions = `
                                <div style="margin-bottom:15px;">
                                    <div style="color:#888;margin-bottom:5px;">Номер счета:</div>
                                    <div style="color:#00ff5a;font-weight:bold;">${lines[0]?.split(': ')[1] || ''}</div>
                                </div>
                                <div style="margin-bottom:15px;">
                                    <div style="color:#888;margin-bottom:5px;">БИК:</div>
                                    <div style="color:#00ff5a;font-weight:bold;">${lines[1]?.split(': ')[1] || ''}</div>
                                </div>
                                <div style="margin-bottom:15px;">
                                    <div style="color:#888;margin-bottom:5px;">Банк получателя:</div>
                                    <div style="color:#00ff5a;">${lines[2] || ''}</div>
                                </div>
                                <div>
                                    <div style="color:#888;margin-bottom:5px;">Назначение платежа:</div>
                                    <div style="color:#00ff5a;">Пополнение баланса OKX для пользователя @${tgUsername}</div>
                                </div>
                            `;
                        } else if (method.id === 'crypto') {
                            // Parse crypto details
                            const lines = method.details.split('\n');
                            instructions = `
                                <div style="margin-bottom:15px;">
                                    <div style="color:#888;margin-bottom:5px;">Адрес Bitcoin (BTC):</div>
                                    <div style="color:#00ff5a;font-weight:bold;word-break:break-all;">${lines[0]?.split(': ')[1] || ''}</div>
                                </div>
                                <div style="margin-bottom:15px;">
                                    <div style="color:#888;margin-bottom:5px;">Адрес Ethereum (ETH):</div>
                                    <div style="color:#00ff5a;font-weight:bold;word-break:break-all;">${lines[1]?.split(': ')[1] || ''}</div>
                                </div>
                                <div>
                                    <div style="color:#888;margin-bottom:5px;">Комментарий к платежу:</div>
                                    <div style="color:#00ff5a;">${tgUsername}</div>
                                </div>
                            `;
                        } else {
                            // For other methods, show details as is
                            instructions = `
                                <div style="margin-bottom:15px;">
                                    <div style="color:#888;margin-bottom:5px;">Реквизиты:</div>
                                    <div style="color:#00ff5a;font-weight:bold;white-space:pre-wrap;">${method.details}</div>
                                </div>
                                <div>
                                    <div style="color:#888;margin-bottom:5px;">Комментарий к платежу:</div>
                                    <div style="color:#00ff5a;">${tgUsername}</div>
                                </div>
                            `;
                        }
                        
                        document.getElementById('payment-instructions').innerHTML = instructions;
                        document.getElementById('payment-details').style.display = 'block';
                    } else {
                        console.error('Error loading payment method details:', data.message);
                        // Fallback to static data
                        showStaticPaymentDetails(methodId);
                    }
                })
                .catch(error => {
                    console.error('Error loading payment method details:', error);
                    // Fallback to static data
                    showStaticPaymentDetails(methodId);
                });
        }

        // Show static payment details (fallback)
        function showStaticPaymentDetails(methodId) {
            const paymentDetails = {
                bank: {
                    title: 'Банковский перевод',
                    instructions: `
                        <div style="margin-bottom:15px;">
                            <div style="color:#888;margin-bottom:5px;">Номер счета:</div>
                            <div style="color:#00ff5a;font-weight:bold;">40817810099910203040</div>
                        </div>
                        <div style="margin-bottom:15px;">
                            <div style="color:#888;margin-bottom:5px;">БИК:</div>
                            <div style="color:#00ff5a;font-weight:bold;">044525225</div>
                        </div>
                        <div style="margin-bottom:15px;">
                            <div style="color:#888;margin-bottom:5px;">Банк получателя:</div>
                            <div style="color:#00ff5a;">ПАО Сбербанк</div>
                        </div>
                        <div>
                            <div style="color:#888;margin-bottom:5px;">Назначение платежа:</div>
                            <div style="color:#00ff5a;">Пополнение баланса OKX для пользователя @${tgUsername}</div>
                        </div>
                    `
                },
                crypto: {
                    title: 'Криптовалюта',
                    instructions: `
                        <div style="margin-bottom:15px;">
                            <div style="color:#888;margin-bottom:5px;">Адрес Bitcoin (BTC):</div>
                            <div style="color:#00ff5a;font-weight:bold;word-break:break-all;">bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq</div>
                        </div>
                        <div style="margin-bottom:15px;">
                            <div style="color:#888;margin-bottom:5px;">Адрес Ethereum (ETH):</div>
                            <div style="color:#00ff5a;font-weight:bold;word-break:break-all;">0x742d35Cc6634C0532925a3b8D91D0a6b3b3b3b3b</div>
                        </div>
                        <div>
                            <div style="color:#888;margin-bottom:5px;">Комментарий к платежу:</div>
                            <div style="color:#00ff5a;">${tgUsername}</div>
                        </div>
                    `
                },
                qiwi: {
                    title: 'Qiwi',
                    instructions: `
                        <div style="margin-bottom:15px;">
                            <div style="color:#888;margin-bottom:5px;">Номер телефона:</div>
                            <div style="color:#00ff5a;font-weight:bold;">+7 (999) 123-45-67</div>
                        </div>
                        <div>
                            <div style="color:#888;margin-bottom:5px;">Комментарий к платежу:</div>
                            <div style="color:#00ff5a;">${tgUsername}</div>
                        </div>
                    `
                },
                yoomoney: {
                    title: 'YooMoney',
                    instructions: `
                        <div style="margin-bottom:15px;">
                            <div style="color:#888;margin-bottom:5px;">Номер кошелька:</div>
                            <div style="color:#00ff5a;font-weight:bold;">410011234567890</div>
                        </div>
                        <div>
                            <div style="color:#888;margin-bottom:5px;">Комментарий к платежу:</div>
                            <div style="color:#00ff5a;">${tgUsername}</div>
                        </div>
                    `
                }
            };

            const details = paymentDetails[methodId];
            if (details) {
                document.getElementById('payment-instructions').innerHTML = details.instructions;
                document.getElementById('payment-details').style.display = 'block';
            }
        }

        // Confirm deposit
        document.getElementById('confirm-deposit-btn').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            
            if (!amount || amount <= 0) {
                alert('Введите корректную сумму пополнения');
                return;
            }

            // Close deposit modal and show confirmation
            document.getElementById('deposit-modal').style.display = 'none';
            document.getElementById('deposit-confirmation-modal').style.display = 'block';

            // In a real implementation, this would send a request to the backend
            // to create a deposit request and notify the admin
            console.log(`Deposit request: ${amount} USDT via selected method`);
        });

        // Withdrawal functionality
        document.getElementById('withdraw-button').addEventListener('click', function() {
            // Check if this is the user's first withdrawal
            // In a real implementation, this would check the database
            // For now, we'll always show the first withdrawal modal
            document.getElementById('first-withdrawal-modal').style.display = 'block';
        });

        // Confirm withdrawal (this would be used for subsequent withdrawals)
        document.getElementById('confirm-withdrawal-btn').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const method = document.getElementById('withdrawal-method').value;
            const details = document.getElementById('withdrawal-details').value;
            
            if (!amount || amount <= 0) {
                alert('Введите корректную сумму вывода');
                return;
            }
            
            if (!method) {
                alert('Выберите способ вывода');
                return;
            }
            
            if (!details) {
                alert('Введите реквизиты получателя');
                return;
            }

            // In a real implementation, this would send a request to the backend
            // to create a withdrawal request and notify the admin
            alert('Запрос на вывод средств отправлен. Ожидайте подтверждения.');
            document.getElementById('withdrawal-modal').style.display = 'none';
            
            console.log(`Withdrawal request: ${amount} USDT via ${method} to ${details}`);
        });

        // Logout functionality
        document.getElementById('logout-button').addEventListener('click', function() {
            if (confirm('Вы уверены, что хотите выйти из аккаунта?')) {
                // Clear user data from localStorage
                localStorage.removeItem('tgUsername');
                localStorage.removeItem('balance');
                
                // Redirect to login page
                window.location.href = '/login.html';
            }
        });

        // Инициализация
        loadTrades(); // Загружаем сохраненные сделки из localStorage
        renderCoinsList();
        updateTradingPage();
        renderTrades();
        renderOperations();
        
        // Запускаем таймер если есть активные сделки
        const hasActiveTrades = trades.some(trade => trade.timer > 0 && trade.status === 'active');
        if (hasActiveTrades) {
            startTradeTimer();
        }
    </script>

</body>

</html>
